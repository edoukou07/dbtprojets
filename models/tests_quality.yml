# Advanced data quality tests for facts and dimensions

version: 2

models:
  # ===== FACT TABLES =====
  - name: fait_attributions
    description: "Quality tests for the allocations fact table"
    tests:
      # Verify that data is recent (less than 30 days)
      - dbt_utils.recency:
          arguments:
            datepart: day
            field: date_modification
            interval: 30
    columns:
      - name: montant_attribution
        description: "Total investment amount"
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 100000000000  # 100 billion FCFA max
          # - not_null  # Temporarily disabled - 12 NULL values to fix in source
      
      - name: superficie_demandee
        description: "Requested area in m2 (max 50,000 m2 = 5 hectares)"
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 50000  # 50,000 m2 = 5 hectares for large industrial projects

  - name: fait_factures
    columns:
      - name: montant_total
        tests:
          - dbt_utils.not_null_proportion:
              arguments:
                at_least: 0.95  # At least 95% non-null values
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 10000000000  # 10 billion FCFA max

  - name: fait_paiements
    columns:
      - name: montant_paiement
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
          - not_null
      
      - name: date_paiement_key
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_temps')
                field: date_key

  - name: fait_collectes
    columns:
      - name: montant_a_recouvrer
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

  # ===== DIMENSIONS =====
  - name: dim_entreprises
    tests:
      # Verify that each combination is unique
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - entreprise_key
    columns:
      - name: entreprise_key
        tests:
          - unique
          - not_null
      
      - name: raison_sociale
        tests:
          - not_null

  - name: dim_lots
    columns:
      - name: lot_key
        tests:
          - unique
          - not_null
      
      - name: superficie
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 1000000  # 100 hectares max

  - name: dim_zones_industrielles
    columns:
      - name: zone_key
        tests:
          - unique
          - not_null

  - name: dim_temps
    columns:
      - name: date_key
        tests:
          - unique
          - not_null
      
      - name: annee
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 2020
                max_value: 2030

  - name: dim_domaines_activites
    columns:
      - name: domaine_key
        tests:
          - unique
          - not_null
