# SIGETI - Architecture & Features (Data / Backend / Frontend)

This document summarizes implemented features per project part: Data (dbt & DWH), Backend (Django API & AI), and Frontend (React UI). It lists key files, endpoints, components and workflows.

---

## 1) Data (dbt, models, snapshots)

Main responsibilities:

- Extract-transform-load flows (dbt) that build staging, dimension and mart tables
- Precomputed KPIs (marts) used by the dashboards and backend APIs
- Snapshots for historical records

Key directories and files:
- `models/staging/` - staging models for facts and dimensions (e.g., `stg_factures.sql`, `stg_paiements.sql`, `stg_entreprises.sql`)
- `models/marts/` - analytic marts materialized as tables:
  - `models/marts/financier/mart_performance_financiere.sql` - financial KPIs (CA, DSO, taux paiement, créances, recouvrement)
  - `models/marts/occupation/mart_occupation_zones.sql` - occupation metrics (lots, surfaces, taux d'occupation, viabilisation)
  - `models/marts/clients/mart_portefeuille_clients.sql` - client portfolio KPIs
  - `models/marts/operationnel/mart_kpi_operationnels.sql` - operational KPIs
- `snapshots/` - e.g., `snapshot_entreprises.sql` to capture changes over time for dimension tables
- `macros/` - dbt macros for common transformations (check `macros/` directory for helpers)
- `target/` - compiled SQL and tests generated by dbt (useful for debugging and to understand generated SQL)

Functionality implemented:
- Materialized marts for fast dashboard queries (indexes are defined for performance)
- Basic tests and good-practice macros in `models/tests_quality.yml`
- DWH refresh routines and scheduled tasks to keep marts up-to-date

How to run locally:
- Use dbt commands from the project root:
  - `dbt run --models +mart_*` - run mart models
  - `dbt test` - run tests
- See `docs/SETUP_PRIORITE3.md` for deployment instructions and `docs/INDEXATION_GUIDE.md` for indexing details

---

## 2) Backend (Django REST API, AI & alerting)

Main responsibilities:
- Expose REST APIs used by the frontend
- Serve aggregated KPI endpoints, search and trend analysis
- Authentication and security (JWT + legacy endpoints)
- Alerts and threshold management (auto alerts based on thresholds)
- AI Chatbot for text-to-SQL and conversational analytics
- Monitoring & logging endpoints

Key directories and files:
- `bi_app/backend/api/` - core REST API
  - `views.py` - viewsets and endpoints (e.g., `MartPerformanceFinanciereViewSet`, `MartOccupationZonesViewSet`, `AlertViewSet`)
  - `serializers.py` - DRF serializers mapping models to JSON
  - `urls.py` - API router and endpoints mapping (paths like `/api/financier/summary/`)
  - `cache_decorators.py` - caching of expensive endpoints
  - `auth_views.py` & `logout_view` - JWT-based and legacy authentication
  - `alert_config_views.py` - alert management and thresholds APIs
  - `refresh_views.py` - refresh materialized views endpoints for DWH

- `bi_app/backend/analytics/models.py` - ORM models for marts (read-only)
- `bi_app/backend/ai_chat/` - AI query engine and services
  - `query_engine.py` - hybrid engine which can use OpenAI GPT (text-to-SQL) or a rules engine to produce SQL and structured responses
  - `chat_service.py` - higher-level service wrapping query engine and trend analysis modules
  - `urls.py` (under `ai_chat`) - paths like `/api/ai/query/`, `/api/ai/configure/` for admin
  - `TREND_ANALYSIS.md` and `README.md` - docs for AI features

- `bi_app/backend/test_*.py` - test scripts and CLI helpers used to verify endpoints
- `bi_app/backend/scripts/` - helper scripts (e.g., `generate_alerts.py`, debug scripts)

High-level endpoints and functionality:
- Dashboard APIs (summaries and trends):
  - `GET /api/financier/summary/` → financial summary (CA, impayés, taux paiements, delai moyen paiement, recouvrement)
  - `GET /api/occupation/summary/` → occupation summary
  - `GET /api/clients/summary/` → client portfolio summary
  - `GET /api/operationnel/summary/` → operational summary
  - Additional endpoints for `by_zone`, `tendances_mensuelles`, `tendances_trimestrielles`, `analyse_recouvrement`, `top_zones_performance`, etc.

- Alerts & Thresholds:
  - `GET/POST /api/alerts/` - CRUD alerts
  - `GET /api/alerts/active/` - list active alerts
  - `POST /api/alerts/{id}/acknowledge/` - acknowledge
  - `POST /api/alerts/{id}/resolve/` - resolve
  - `POST /api/alerts/check_thresholds/` - run threshold checks (can be scheduled)
  - `GET /api/alert-thresholds/` and config endpoints for threshold rules

- Authentication:
  - JWT endpoints: `/api/auth/jwt/token/`, `/api/auth/jwt/refresh/`, `/api/auth/jwt/login/` — default auth in `sigeti_bi.settings`
  - Legacy login: `/api/auth/login/` (JWT & Token compatibility)

- AI Chat & Query Engine:
  - `POST /api/ai/query/` - ask the system for analytics (text-to-SQL) — returns results or suggestions
  - OpenAI integration is optional: configure `OPENAI_API_KEY` in environment or via `/api/ai/configure/`
  - The hybrid engine uses rule-based patterns first, then falls back to OpenAI

- Monitoring & Logs:
  - `/api/monitoring/metrics/`, `/api/monitoring/logs/`, `/api/monitoring/errors/`, `/api/monitoring/slow/` - metrics and query diagnostics
  - Logging of slow requests and request tracing is implemented in middleware

Notable implementation details:
- `MartPerformanceFinanciereViewSet.summary` contains logic to guard against DB returning `datetime.timedelta` for `AVG(delai)`; code normalizes into days and returns float — protects APIs from TypeError during aggregation.
- Caching decorator `cache_api_response` is used across summary endpoints to avoid frequent compute.
- Alert rules are extendable in `AlertThreshold` DB and checked by `check_thresholds` view. Alerts avoid duplication by searching recent active alerts and context.
- The AI Query Engine is pluggable; uses `OpenAIQueryEngine` when `OPENAI_API_KEY` is present, otherwise executes pre-defined rules.

How to run:
- Start Django: `cd bi_app/backend && python manage.py runserver`
- Use `python manage.py shell` to run debug scripts and test scripts in `bi_app/backend/test_*.py`

---

## 3) Frontend (React & Vite)

Main responsibilities:

Key directories and files:
  - `Dashboard.jsx` - main dashboards page using financial & operational summary endpoints
  - `Financier.jsx` - detailed financial dashboards and charts
  - `Occupation.jsx` / `OccupationZoneDetails.jsx` - maps and zone details
  - `Clients.jsx`, `ClientDetails.jsx` - client list, detail and segmentation
  - `Portefeuille.jsx` - portfolio related charts
  - `AlertsAnalytics.jsx` - alerts analytics UI
  - `ReportConfig.jsx` - page where user can schedule or send reports by email (choose dashboard, recipients, date/time)
  - `Login.jsx` - login page for authentication

- `bi_app/frontend/src/components/` — reusable components:
  - `ZonesMap.jsx` - leaflet-based map visualization
  - `ProtectedRoute.jsx` - React Router guard for authenticated routes

Frontend libraries and patterns:
- React + Vite for fast dev build
- React Router DOM for routing
- React Query for server state caching and data fetching
- Axios with a configured `api` wrapper (`bi_app/frontend/src/services/api.js`) to handle authentication tokens and 401 redirects
- Tailwind CSS for styles; `lucide-react` icons
- Chart libs (e.g., recharts) for analytics visualizations (pie, treemap, charts); some visualizations were removed per request

How frontend consumes APIs:
- Uses `services/api.js` as a single place to call backend endpoints, e.g., `financierAPI.getSummary()` for dashboard KPIs
- JWT token stored in `localStorage` and added via axios interceptor

How to run locally:
- In `bi_app/frontend` run: `npm install` then `npm run dev`
- The app expects the backend server at `http://localhost:8000` by default (see `API_BASE_URL` in `services/api.js`)

---

## 4) Developer/CI & Tests

- Tests are currently present as scripts under `bi_app/backend/test_*.py` — they set up the Django environment and run sample queries.
- Data quality and dbt tests are in `models/tests_quality.yml` — use `dbt test` to validate them
- Git & CI: follow `docs/DEPLOYMENT_GUIDE.md` for CI/CD steps; staging & deployment details are in the repository docs

---

## 5) Next recommended improvements

- Convert script-like backend tests into Django `unittest.TestCase` classes for easier CI integration
- Add an integration test for the AI Query Engine (requires mocking OpenAI or toggling rules engine)
- Add more doc examples for `ReportConfig` and connect it to a backend endpoint to persist configuration
- Add database-side conversion for `delai_moyen_paiement` (if DB is Postgres, use `EXTRACT(epoch FROM interval)/86400` to get days) for large datasets
- Improve alert rule UI to manage thresholds per environment

---

## 6) Quick commands

- Backend
```
cd bi_app/backend
python manage.py runserver
python manage.py shell -c "exec(open('test_financier_summary.py').read())"
```
- Frontend
```
cd bi_app/frontend
npm install
npm run dev
```
- Data (dbt)
```
dbt deps
dbt seed
dbt run --models mart_*
dbt test
```

---

## 7) Links to key files

- Data: `models/marts/financier/mart_performance_financiere.sql`, `models/marts/occupation/mart_occupation_zones.sql`, `snapshots/snapshot_entreprises.sql`
- Backend: `bi_app/backend/api/views.py`, `bi_app/backend/analytics/models.py`, `bi_app/backend/ai_chat/query_engine.py` 
- Frontend: `bi_app/frontend/src/pages/*`, `bi_app/frontend/src/components/*`, `bi_app/frontend/src/services/api.js`

---

This doc is an overview; if you want a deeper design doc for each subsystem (API contract, request/response examples or data lineage diagrams), tell me which subsystem you want to expand first.
