{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.15", "generated_at": "2025-11-18T01:13:53.522402Z", "invocation_id": "b8a10d56-c84e-487f-9760-0d736afdbefb", "invocation_started_at": "2025-11-18T01:13:50.208815Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-18T01:13:53.031994Z", "completed_at": "2025-11-18T01:13:53.042564Z"}, {"name": "execute", "started_at": "2025-11-18T01:13:53.042564Z", "completed_at": "2025-11-18T01:13:53.442508Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.41253042221069336, "adapter_response": {"_message": "SELECT 35", "code": "SELECT", "rows_affected": 35}, "message": "SELECT 35", "failures": null, "unique_id": "model.sigeti_dwh.mart_portefeuille_clients", "compiled": true, "compiled_code": "\n\n-- Mart Clients - Analyse du portefeuille clients/entreprises\n-- Materialized en table pour performance optimale des dashboards\n-- Structure: Pre-aggregation dans CTEs separees pour eviter les doublocomptes de JOINs\n\nwith entreprises as (\n    select * from \"sigeti_node_db\".\"dwh_dimensions\".\"dim_entreprises\"\n),\n\ndomaines as (\n    select * from \"sigeti_node_db\".\"dwh_dimensions\".\"dim_domaines_activites\"\n),\n\nfactures_raw as (\n    select * from \"sigeti_node_db\".\"dwh_facts\".\"fait_factures\"\n),\n\nattributions_raw as (\n    select * from \"sigeti_node_db\".\"dwh_facts\".\"fait_attributions\"\n),\n\nlots_raw as (\n    select * from \"sigeti_node_db\".\"dwh_dimensions\".\"dim_lots\"\n),\n\n-- Pre-aggregate factures by entreprise_id to avoid multiplications\nfactures_stats as (\n    select\n        f.entreprise_id,\n        count(distinct f.facture_id) as nombre_factures,\n        sum(f.montant_total) as chiffre_affaires_total,\n        sum(case when f.est_paye then f.montant_total else 0 end) as ca_paye,\n        sum(case when not f.est_paye then f.montant_total else 0 end) as ca_impaye,\n        avg(f.delai_paiement_jours) as delai_moyen_paiement,\n        count(case when f.est_en_retard then 1 end) as nombre_factures_retard,\n        round(\n            (count(case when f.est_paye then 1 end)::numeric / \n             nullif(count(f.facture_id), 0)::numeric * 100), \n            2\n        ) as taux_paiement_pct\n    from factures_raw f\n    group by f.entreprise_id\n),\n\n-- Pre-aggregate attributions by entreprise_id to avoid multiplications\nattributions_stats as (\n    select\n        a.entreprise_id,\n        count(distinct a.demande_id) as nombre_demandes,\n        count(distinct case when a.est_approuve then a.demande_id end) as demandes_approuvees,\n        sum(case when a.est_approuve then a.superficie_demandee else 0 end) as superficie_totale_attribuee\n    from attributions_raw a\n    group by a.entreprise_id\n),\n\n-- Pre-aggregate lots by entreprise_id to avoid multiplications\nlots_stats as (\n    select\n        l.entreprise_id,\n        count(distinct l.lot_id) as nombre_lots_attribues\n    from lots_raw l\n    where l.est_attribue\n    group by l.entreprise_id\n),\n\n-- Final join with pre-aggregated data - no risk of row multiplication\nclients_stats as (\n    select\n        e.entreprise_id,\n        e.raison_sociale,\n        e.forme_juridique,\n        e.registre_commerce,\n        e.telephone,\n        e.email,\n        d.nom_domaine as secteur_activite,\n        \n        -- Facturation\n        coalesce(f.nombre_factures, 0) as nombre_factures,\n        coalesce(f.chiffre_affaires_total, 0) as chiffre_affaires_total,\n        coalesce(f.ca_paye, 0) as ca_paye,\n        coalesce(f.ca_impaye, 0) as ca_impaye,\n        f.delai_moyen_paiement,\n        coalesce(f.nombre_factures_retard, 0) as nombre_factures_retard,\n        f.taux_paiement_pct,\n        \n        -- Attributions\n        coalesce(a.nombre_demandes, 0) as nombre_demandes,\n        coalesce(a.demandes_approuvees, 0) as demandes_approuvees,\n        coalesce(a.superficie_totale_attribuee, 0) as superficie_totale_attribuee,\n        \n        -- Lots\n        coalesce(l.nombre_lots_attribues, 0) as nombre_lots_attribues,\n        \n        -- Segmentation client\n        case \n            when coalesce(f.chiffre_affaires_total, 0) > 10000000 then 'Grand client'\n            when coalesce(f.chiffre_affaires_total, 0) > 1000000 then 'Client moyen'\n            else 'Petit client'\n        end as segment_client,\n        \n        case \n            when coalesce(f.nombre_factures_retard, 0)::numeric / \n                 nullif(coalesce(f.nombre_factures, 0), 0)::numeric > 0.3 then 'Risque elev\u00e9'\n            when coalesce(f.nombre_factures_retard, 0)::numeric / \n                 nullif(coalesce(f.nombre_factures, 0), 0)::numeric > 0.1 then 'Risque moyen'\n            else 'Risque faible'\n        end as niveau_risque\n        \n    from entreprises e\n    left join domaines d on e.domaine_activite_id = d.domaine_id\n    left join factures_stats f on e.entreprise_id = f.entreprise_id\n    left join attributions_stats a on e.entreprise_id = a.entreprise_id\n    left join lots_stats l on e.entreprise_id = l.entreprise_id\n)\n\nselect * from clients_stats\norder by chiffre_affaires_total desc nulls last", "relation_name": "\"sigeti_node_db\".\"dwh_marts_clients\".\"mart_portefeuille_clients\"", "batch_results": null}], "elapsed_time": 1.0562820434570312, "args": {"empty": false, "print": true, "quiet": false, "favor_state": false, "partial_parse": true, "macro_debugging": false, "use_fast_test_edges": false, "strict_mode": false, "static_parser": true, "partial_parse_file_diff": true, "project_dir": "C:\\Users\\hynco\\Desktop\\DWH_SIG", "use_colors_file": true, "log_format_file": "debug", "show_resource_report": false, "invocation_command": "dbt run --select mart_portefeuille_clients", "require_batched_execution_for_custom_microbatch_strategy": false, "show_all_deprecations": false, "state_modified_compare_more_unrendered_values": false, "upload_to_artifacts_ingest_api": false, "printer_width": 80, "state_modified_compare_vars": false, "indirect_selection": "eager", "write_json": true, "introspect": true, "require_resource_names_without_spaces": true, "use_colors": true, "warn_error_options": {"error": [], "warn": [], "silence": []}, "log_file_max_bytes": 10485760, "skip_nodes_if_on_run_start_fails": false, "defer": false, "exclude": [], "populate_cache": true, "send_anonymous_usage_stats": true, "log_path": "C:\\Users\\hynco\\Desktop\\DWH_SIG\\logs", "vars": {}, "require_generic_test_arguments_property": true, "require_yaml_configuration_for_mf_time_spines": false, "require_all_warnings_handled_by_warn_error": false, "log_level_file": "debug", "log_level": "info", "validate_macro_args": false, "which": "run", "require_explicit_package_overrides_for_builtin_materializations": true, "source_freshness_run_project_hooks": true, "require_nested_cumulative_type_params": false, "version_check": true, "profiles_dir": "C:\\Users\\hynco\\Desktop\\DWH_SIG", "cache_selected_only": false, "select": ["mart_portefeuille_clients"], "log_format": "default"}}