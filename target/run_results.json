{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.15", "generated_at": "2025-11-19T14:10:18.616574Z", "invocation_id": "73cb4866-ade4-4337-b344-7d92eb20a303", "invocation_started_at": "2025-11-19T14:10:13.377209Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-19T14:10:16.833797Z", "completed_at": "2025-11-19T14:10:16.845768Z"}, {"name": "execute", "started_at": "2025-11-19T14:10:16.846765Z", "completed_at": "2025-11-19T14:10:18.530057Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 1.699004888534546, "adapter_response": {"_message": "SELECT 4", "code": "SELECT", "rows_affected": 4}, "message": "SELECT 4", "failures": null, "unique_id": "model.sigeti_dwh.mart_performance_financiere", "compiled": true, "compiled_code": "\n\n-- Financial Performance Mart - Corrected Logic\n-- IMPORTANT: Join on trimestre level, NOT month level (to avoid duplicating collectes data)\n\nwith factures as (\n    select\n        f.facture_id,\n        f.montant_total,\n        f.est_paye,\n        f.delai_paiement_jours,\n        f.date_creation,\n        f.demande_attribution_id,\n        extract(year from f.date_creation)::int as annee,\n        extract(month from f.date_creation)::int as mois,\n        extract(quarter from f.date_creation)::int as trimestre\n    from \"sigeti_node_db\".\"dwh_facts\".\"fait_factures\" f\n),\n\n-- Join factures with zones via demandes_attribution\nfactures_avec_zones as (\n    select\n        f.*,\n        coalesce(z.libelle, 'Zone Principale') as nom_zone\n    from factures f\n    left join \"sigeti_node_db\".public.demandes_attribution da \n        on f.demande_attribution_id = da.id\n    left join \"sigeti_node_db\".public.lots l \n        on da.lot_id = l.id\n    left join \"sigeti_node_db\".public.zones_industrielles z \n        on l.zone_industrielle_id = z.id\n),\n\ncollectes as (\n    select\n        c.collecte_id,\n        c.montant_a_recouvrer,\n        c.montant_recouvre,\n        c.taux_recouvrement,\n        c.duree_reelle_jours,\n        extract(year from c.date_debut)::int as annee,\n        extract(quarter from c.date_debut)::int as trimestre\n    from \"sigeti_node_db\".\"dwh_facts\".\"fait_collectes\" c\n),\n\n-- Aggregate factures by MONTH (for monthly trends)\nfactures_aggregees_mois as (\n    select\n        f.annee,\n        f.mois,\n        f.trimestre,\n        f.nom_zone,\n        count(distinct f.facture_id) as nombre_factures,\n        sum(f.montant_total) as montant_total_facture,\n        sum(case when f.est_paye then f.montant_total else 0 end) as montant_paye,\n        sum(case when not f.est_paye then f.montant_total else 0 end) as montant_impaye,\n        round(avg(coalesce(extract(day from f.delai_paiement_jours), 0))::numeric, 2) as delai_moyen_paiement,\n        round(\n            (sum(case when f.est_paye then f.montant_total else 0 end)::numeric / \n             nullif(sum(f.montant_total), 0)::numeric * 100), \n            2\n        ) as taux_paiement_pct\n    from factures_avec_zones f\n    group by f.annee, f.mois, f.trimestre, f.nom_zone\n),\n\n-- Aggregate collectes by TRIMESTRE ONLY (for collectes data, which is quarterly)\ncollectes_aggregees_trimestre as (\n    select\n        c.annee,\n        c.trimestre,\n        count(distinct c.collecte_id) as nombre_collectes,\n        sum(c.montant_a_recouvrer) as montant_total_a_recouvrer,\n        sum(case when c.montant_recouvre > 0 then c.montant_recouvre else 0 end) as montant_total_recouvre,\n        round(avg(coalesce(c.taux_recouvrement, 0))::numeric, 2) as taux_recouvrement_moyen,\n        round(avg(abs(coalesce(c.duree_reelle_jours, 0)))::numeric, 1) as duree_moyenne_collecte\n    from collectes c\n    group by c.annee, c.trimestre\n)\n\nselect\n    f.annee,\n    f.mois,\n    f.trimestre,\n    f.nom_zone,\n    f.nombre_factures,\n    f.montant_total_facture,\n    f.montant_paye,\n    f.montant_impaye,\n    f.delai_moyen_paiement,\n    f.taux_paiement_pct,\n    coalesce(c.nombre_collectes, 0)::int as nombre_collectes,\n    coalesce(c.montant_total_a_recouvrer, 0) as montant_total_a_recouvrer,\n    coalesce(c.montant_total_recouvre, 0) as montant_total_recouvre,\n    coalesce(c.taux_recouvrement_moyen, 0) as taux_recouvrement_moyen,\n    coalesce(c.duree_moyenne_collecte, 0) as duree_moyenne_collecte\nfrom factures_aggregees_mois f\nleft join collectes_aggregees_trimestre c \n    on f.annee = c.annee \n    and f.trimestre = c.trimestre\norder by f.annee desc, f.mois desc", "relation_name": "\"sigeti_node_db\".\"dwh_marts_financier\".\"mart_performance_financiere\"", "batch_results": null}], "elapsed_time": 2.922083616256714, "args": {"printer_width": 80, "partial_parse": true, "use_fast_test_edges": false, "require_all_warnings_handled_by_warn_error": false, "require_yaml_configuration_for_mf_time_spines": false, "show_resource_report": false, "upload_to_artifacts_ingest_api": false, "write_json": true, "defer": false, "source_freshness_run_project_hooks": true, "require_resource_names_without_spaces": true, "show_all_deprecations": false, "vars": {}, "require_nested_cumulative_type_params": false, "macro_debugging": false, "partial_parse_file_diff": true, "project_dir": "C:\\Users\\hynco\\Desktop\\DWH_SIG", "quiet": false, "print": true, "which": "run", "send_anonymous_usage_stats": true, "log_format": "default", "warn_error_options": {"error": [], "warn": [], "silence": []}, "exclude": [], "version_check": true, "empty": false, "state_modified_compare_more_unrendered_values": false, "require_generic_test_arguments_property": true, "require_explicit_package_overrides_for_builtin_materializations": true, "introspect": true, "populate_cache": true, "profiles_dir": ".", "invocation_command": "dbt run --select mart_performance_financiere --profiles-dir .", "log_file_max_bytes": 10485760, "state_modified_compare_vars": false, "use_colors_file": true, "use_colors": true, "favor_state": false, "select": ["mart_performance_financiere"], "log_level": "info", "skip_nodes_if_on_run_start_fails": false, "validate_macro_args": false, "strict_mode": false, "indirect_selection": "eager", "static_parser": true, "log_level_file": "debug", "require_batched_execution_for_custom_microbatch_strategy": false, "cache_selected_only": false, "log_format_file": "debug", "log_path": "C:\\Users\\hynco\\Desktop\\DWH_SIG\\logs"}}